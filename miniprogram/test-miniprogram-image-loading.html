<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç¨‹åºå›¾ç‰‡åŠ è½½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        .status {
            font-weight: bold;
            margin: 10px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background: #1976D2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565C0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .image-container {
            text-align: center;
            margin: 20px 0;
            min-height: 300px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .test-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .url-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª å°ç¨‹åºå›¾ç‰‡åŠ è½½æµ‹è¯•</h1>
        <p>æ­¤é¡µé¢æ¨¡æ‹Ÿå°ç¨‹åºçš„å›¾ç‰‡åŠ è½½æµç¨‹ï¼Œæµ‹è¯•ç­¾åURLçš„ç”Ÿæˆå’Œå›¾ç‰‡è®¿é—®</p>

        <div class="test-section">
            <h3>ğŸ“‹ æµ‹è¯•é…ç½®</h3>
            <div>
                <label>æµ‹è¯•æ–‡ä»¶Key: </label>
                <input type="text" id="fileKey" value="2cec8223-09f6-4d10-9db6-fe804fabd5bd" style="width: 300px; padding: 5px;">
            </div>
            <div style="margin-top: 10px;">
                <label>å›¾ç‰‡ç±»å‹: </label>
                <select id="imageType">
                    <option value="preview">é¢„è§ˆå›¾ (preview)</option>
                    <option value="original">åŸå›¾ (original)</option>
                    <option value="thumb">ç¼©ç•¥å›¾ (thumb)</option>
                </select>
            </div>
            <button onclick="startTest()">ğŸš€ å¼€å§‹æµ‹è¯•</button>
            <button onclick="clearLog()">ğŸ§¹ æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š æµ‹è¯•çŠ¶æ€</h3>
            <div id="status" class="status loading">ç­‰å¾…å¼€å§‹æµ‹è¯•...</div>
            <div id="progress"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ”— ç­¾åURLä¿¡æ¯</h3>
            <div id="urlInfo">
                <div><strong>è¿‡æœŸæ—¶é—´:</strong> <span id="expireTime">-</span></div>
                <div><strong>å‰©ä½™æ—¶é—´:</strong> <span id="remainingTime">-</span></div>
            </div>
            <div class="url-display" id="signedUrl">ç­‰å¾…ç”Ÿæˆ...</div>
        </div>

        <div class="test-section">
            <h3>ğŸ–¼ï¸ å›¾ç‰‡æ˜¾ç¤º</h3>
            <div class="image-container" id="imageContainer">
                <div class="loading">ç­‰å¾…åŠ è½½å›¾ç‰‡...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ æµ‹è¯•æ—¥å¿—</h3>
            <div class="log" id="testLog"></div>
        </div>
    </div>

    <script>
        let currentSignedUrl = '';
        let testStartTime = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const colorMap = {
                'info': '#0f0',
                'success': '#0f0',
                'error': '#f00',
                'warning': '#ff0'
            };
            
            logElement.innerHTML += `<div style="color: ${colorMap[type] || '#0f0'}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // æ¨¡æ‹Ÿå°ç¨‹åºçš„request.requestæ–¹æ³•
        async function mockWxRequest(url, options) {
            const fullUrl = `http://localhost:3000${url}`;
            log(`å‘èµ·è¯·æ±‚: ${options.method} ${fullUrl}`);
            
            const response = await fetch(fullUrl, {
                method: options.method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(options.data)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            log(`è¯·æ±‚æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
            return data;
        }

        // æ¨¡æ‹Ÿå°ç¨‹åºçš„getSignedUrlForPhotoæ–¹æ³•
        async function getSignedUrlForPhoto(fileKey, type) {
            try {
                log(`å¼€å§‹è·å–ç­¾åURL: fileKey=${fileKey}, type=${type}`);
                
                const maxRetries = 3;
                let lastError = null;
                
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        log(`å°è¯•è·å–ç­¾åURL (ç¬¬${attempt}æ¬¡)...`);
                        
                        const response = await mockWxRequest('/upload/signed-url', {
                            method: 'POST',
                            data: {
                                fileKey: fileKey,
                                type: type
                            }
                        });
                        
                        if (response && response.url) {
                            log(`è·å–åˆ°ç­¾åURL: ${response.url}`, 'success');
                            
                            // éªŒè¯ç­¾åURLæ˜¯å¦æœ‰æ•ˆ
                            try {
                                const url = new URL(response.url);
                                const params = new URLSearchParams(url.search);
                                const expires = parseInt(params.get('expires'));
                                const currentTime = Date.now();
                                
                                if (expires && expires > currentTime) {
                                    log(`âœ… ç­¾åURLæœ‰æ•ˆï¼Œè¿‡æœŸæ—¶é—´: ${new Date(expires).toLocaleString()}`, 'success');
                                    
                                    // æ›´æ–°URLä¿¡æ¯æ˜¾ç¤º
                                    document.getElementById('expireTime').textContent = new Date(expires).toLocaleString();
                                    document.getElementById('signedUrl').textContent = response.url;
                                    
                                    // å¯åŠ¨å€’è®¡æ—¶
                                    startCountdown(expires);
                                    
                                    return response.url;
                                } else {
                                    log(`âš ï¸ ç­¾åURLå·²è¿‡æœŸï¼Œé‡æ–°è·å–...`, 'warning');
                                    throw new Error('ç­¾åURLå·²è¿‡æœŸ');
                                }
                            } catch (urlError) {
                                log(`âš ï¸ ç­¾åURLæ ¼å¼éªŒè¯å¤±è´¥: ${urlError.message}`, 'warning');
                                return response.url; // ä»ç„¶å°è¯•ä½¿ç”¨
                            }
                        } else {
                            throw new Error('æœªè·å–åˆ°æœ‰æ•ˆçš„ç­¾åURL');
                        }
                    } catch (attemptError) {
                        log(`ç¬¬${attempt}æ¬¡å°è¯•å¤±è´¥: ${attemptError.message}`, 'error');
                        lastError = attemptError;
                        
                        if (attempt < maxRetries) {
                            log('ç­‰å¾…1ç§’åé‡è¯•...', 'warning');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                throw lastError || new Error('è·å–ç­¾åURLå¤±è´¥');
                
            } catch (error) {
                log(`è·å–ç­¾åURLå¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        function startCountdown(expires) {
            const updateCountdown = () => {
                const remaining = expires - Date.now();
                if (remaining > 0) {
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    document.getElementById('remainingTime').textContent = `${minutes}åˆ†${seconds}ç§’`;
                    setTimeout(updateCountdown, 1000);
                } else {
                    document.getElementById('remainingTime').textContent = 'å·²è¿‡æœŸ';
                    document.getElementById('remainingTime').style.color = '#f44336';
                }
            };
            updateCountdown();
        }

        async function testImageLoad(imageUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const startTime = Date.now();
                
                img.onload = () => {
                    const loadTime = Date.now() - startTime;
                    log(`âœ… å›¾ç‰‡åŠ è½½æˆåŠŸï¼Œè€—æ—¶: ${loadTime}ms`, 'success');
                    
                    // æ˜¾ç¤ºå›¾ç‰‡
                    const container = document.getElementById('imageContainer');
                    container.innerHTML = '';
                    img.className = 'test-image';
                    container.appendChild(img);
                    
                    resolve({ success: true, loadTime });
                };
                
                img.onerror = (error) => {
                    const loadTime = Date.now() - startTime;
                    log(`âŒ å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè€—æ—¶: ${loadTime}ms`, 'error');
                    
                    const container = document.getElementById('imageContainer');
                    container.innerHTML = '<div class="error">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
                    
                    reject({ success: false, error, loadTime });
                };
                
                log(`å¼€å§‹åŠ è½½å›¾ç‰‡: ${imageUrl}`);
                img.src = imageUrl;
            });
        }

        async function startTest() {
            testStartTime = Date.now();
            const fileKey = document.getElementById('fileKey').value;
            const imageType = document.getElementById('imageType').value;
            
            if (!fileKey) {
                alert('è¯·è¾“å…¥æ–‡ä»¶Key');
                return;
            }
            
            clearLog();
            log('ğŸš€ å¼€å§‹å°ç¨‹åºå›¾ç‰‡åŠ è½½æµ‹è¯•');
            log(`æµ‹è¯•å‚æ•°: fileKey=${fileKey}, type=${imageType}`);
            
            updateStatus('æ­£åœ¨æµ‹è¯•...', 'info');
            
            try {
                // 1. è·å–ç­¾åURL
                updateStatus('æ­£åœ¨è·å–ç­¾åURL...', 'info');
                const signedUrl = await getSignedUrlForPhoto(fileKey, imageType);
                currentSignedUrl = signedUrl;
                
                // 2. æµ‹è¯•å›¾ç‰‡åŠ è½½
                updateStatus('æ­£åœ¨åŠ è½½å›¾ç‰‡...', 'info');
                await testImageLoad(signedUrl);
                
                // 3. æµ‹è¯•å®Œæˆ
                const totalTime = Date.now() - testStartTime;
                updateStatus(`âœ… æµ‹è¯•å®Œæˆï¼Œæ€»è€—æ—¶: ${totalTime}ms`, 'success');
                log(`ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ€»è€—æ—¶: ${totalTime}ms`, 'success');
                
            } catch (error) {
                const totalTime = Date.now() - testStartTime;
                updateStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                log(`ğŸ’¥ æµ‹è¯•å¤±è´¥: ${error.message}ï¼Œæ€»è€—æ—¶: ${totalTime}ms`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨å¼€å§‹æµ‹è¯•
        window.onload = () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå‡†å¤‡å¼€å§‹æµ‹è¯•');
        };
    </script>
</body>
</html>