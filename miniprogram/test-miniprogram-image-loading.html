<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小程序图片加载测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background: #fafafa;
        }
        .test-section h3 {
            margin-top: 0;
            color: #555;
        }
        .status {
            font-weight: bold;
            margin: 10px 0;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #ff9800; }
        .info { color: #2196F3; }
        button {
            background: #1976D2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1565C0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .image-container {
            text-align: center;
            margin: 20px 0;
            min-height: 300px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .test-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .url-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }
        .log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 小程序图片加载测试</h1>
        <p>此页面模拟小程序的图片加载流程，测试签名URL的生成和图片访问</p>

        <div class="test-section">
            <h3>📋 测试配置</h3>
            <div>
                <label>测试文件Key: </label>
                <input type="text" id="fileKey" value="2cec8223-09f6-4d10-9db6-fe804fabd5bd" style="width: 300px; padding: 5px;">
            </div>
            <div style="margin-top: 10px;">
                <label>图片类型: </label>
                <select id="imageType">
                    <option value="preview">预览图 (preview)</option>
                    <option value="original">原图 (original)</option>
                    <option value="thumb">缩略图 (thumb)</option>
                </select>
            </div>
            <button onclick="startTest()">🚀 开始测试</button>
            <button onclick="clearLog()">🧹 清空日志</button>
        </div>

        <div class="test-section">
            <h3>📊 测试状态</h3>
            <div id="status" class="status loading">等待开始测试...</div>
            <div id="progress"></div>
        </div>

        <div class="test-section">
            <h3>🔗 签名URL信息</h3>
            <div id="urlInfo">
                <div><strong>过期时间:</strong> <span id="expireTime">-</span></div>
                <div><strong>剩余时间:</strong> <span id="remainingTime">-</span></div>
            </div>
            <div class="url-display" id="signedUrl">等待生成...</div>
        </div>

        <div class="test-section">
            <h3>🖼️ 图片显示</h3>
            <div class="image-container" id="imageContainer">
                <div class="loading">等待加载图片...</div>
            </div>
        </div>

        <div class="test-section">
            <h3>📝 测试日志</h3>
            <div class="log" id="testLog"></div>
        </div>
    </div>

    <script>
        let currentSignedUrl = '';
        let testStartTime = 0;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('testLog');
            const colorMap = {
                'info': '#0f0',
                'success': '#0f0',
                'error': '#f00',
                'warning': '#ff0'
            };
            
            logElement.innerHTML += `<div style="color: ${colorMap[type] || '#0f0'}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('testLog').innerHTML = '';
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // 模拟小程序的request.request方法
        async function mockWxRequest(url, options) {
            const fullUrl = `http://localhost:3000${url}`;
            log(`发起请求: ${options.method} ${fullUrl}`);
            
            const response = await fetch(fullUrl, {
                method: options.method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(options.data)
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            const data = await response.json();
            log(`请求成功: ${JSON.stringify(data)}`, 'success');
            return data;
        }

        // 模拟小程序的getSignedUrlForPhoto方法
        async function getSignedUrlForPhoto(fileKey, type) {
            try {
                log(`开始获取签名URL: fileKey=${fileKey}, type=${type}`);
                
                const maxRetries = 3;
                let lastError = null;
                
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        log(`尝试获取签名URL (第${attempt}次)...`);
                        
                        const response = await mockWxRequest('/upload/signed-url', {
                            method: 'POST',
                            data: {
                                fileKey: fileKey,
                                type: type
                            }
                        });
                        
                        if (response && response.url) {
                            log(`获取到签名URL: ${response.url}`, 'success');
                            
                            // 验证签名URL是否有效
                            try {
                                const url = new URL(response.url);
                                const params = new URLSearchParams(url.search);
                                const expires = parseInt(params.get('expires'));
                                const currentTime = Date.now();
                                
                                if (expires && expires > currentTime) {
                                    log(`✅ 签名URL有效，过期时间: ${new Date(expires).toLocaleString()}`, 'success');
                                    
                                    // 更新URL信息显示
                                    document.getElementById('expireTime').textContent = new Date(expires).toLocaleString();
                                    document.getElementById('signedUrl').textContent = response.url;
                                    
                                    // 启动倒计时
                                    startCountdown(expires);
                                    
                                    return response.url;
                                } else {
                                    log(`⚠️ 签名URL已过期，重新获取...`, 'warning');
                                    throw new Error('签名URL已过期');
                                }
                            } catch (urlError) {
                                log(`⚠️ 签名URL格式验证失败: ${urlError.message}`, 'warning');
                                return response.url; // 仍然尝试使用
                            }
                        } else {
                            throw new Error('未获取到有效的签名URL');
                        }
                    } catch (attemptError) {
                        log(`第${attempt}次尝试失败: ${attemptError.message}`, 'error');
                        lastError = attemptError;
                        
                        if (attempt < maxRetries) {
                            log('等待1秒后重试...', 'warning');
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                    }
                }
                
                throw lastError || new Error('获取签名URL失败');
                
            } catch (error) {
                log(`获取签名URL失败: ${error.message}`, 'error');
                throw error;
            }
        }

        function startCountdown(expires) {
            const updateCountdown = () => {
                const remaining = expires - Date.now();
                if (remaining > 0) {
                    const minutes = Math.floor(remaining / 60000);
                    const seconds = Math.floor((remaining % 60000) / 1000);
                    document.getElementById('remainingTime').textContent = `${minutes}分${seconds}秒`;
                    setTimeout(updateCountdown, 1000);
                } else {
                    document.getElementById('remainingTime').textContent = '已过期';
                    document.getElementById('remainingTime').style.color = '#f44336';
                }
            };
            updateCountdown();
        }

        async function testImageLoad(imageUrl) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                const startTime = Date.now();
                
                img.onload = () => {
                    const loadTime = Date.now() - startTime;
                    log(`✅ 图片加载成功，耗时: ${loadTime}ms`, 'success');
                    
                    // 显示图片
                    const container = document.getElementById('imageContainer');
                    container.innerHTML = '';
                    img.className = 'test-image';
                    container.appendChild(img);
                    
                    resolve({ success: true, loadTime });
                };
                
                img.onerror = (error) => {
                    const loadTime = Date.now() - startTime;
                    log(`❌ 图片加载失败，耗时: ${loadTime}ms`, 'error');
                    
                    const container = document.getElementById('imageContainer');
                    container.innerHTML = '<div class="error">图片加载失败</div>';
                    
                    reject({ success: false, error, loadTime });
                };
                
                log(`开始加载图片: ${imageUrl}`);
                img.src = imageUrl;
            });
        }

        async function startTest() {
            testStartTime = Date.now();
            const fileKey = document.getElementById('fileKey').value;
            const imageType = document.getElementById('imageType').value;
            
            if (!fileKey) {
                alert('请输入文件Key');
                return;
            }
            
            clearLog();
            log('🚀 开始小程序图片加载测试');
            log(`测试参数: fileKey=${fileKey}, type=${imageType}`);
            
            updateStatus('正在测试...', 'info');
            
            try {
                // 1. 获取签名URL
                updateStatus('正在获取签名URL...', 'info');
                const signedUrl = await getSignedUrlForPhoto(fileKey, imageType);
                currentSignedUrl = signedUrl;
                
                // 2. 测试图片加载
                updateStatus('正在加载图片...', 'info');
                await testImageLoad(signedUrl);
                
                // 3. 测试完成
                const totalTime = Date.now() - testStartTime;
                updateStatus(`✅ 测试完成，总耗时: ${totalTime}ms`, 'success');
                log(`🎉 所有测试通过，总耗时: ${totalTime}ms`, 'success');
                
            } catch (error) {
                const totalTime = Date.now() - testStartTime;
                updateStatus(`❌ 测试失败: ${error.message}`, 'error');
                log(`💥 测试失败: ${error.message}，总耗时: ${totalTime}ms`, 'error');
            }
        }

        // 页面加载完成后自动开始测试
        window.onload = () => {
            log('页面加载完成，准备开始测试');
        };
    </script>
</body>
</html>