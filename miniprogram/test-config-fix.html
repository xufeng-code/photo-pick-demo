<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONFIG.API_BASE é…ç½®æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #10B981; }
        .error { color: #EF4444; }
        .info { color: #3B82F6; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #d1fae5;
            border: 1px solid #10B981;
        }
        .test-fail {
            background-color: #fee2e2;
            border: 1px solid #EF4444;
        }
    </style>
</head>
<body>
    <h1>CONFIG.API_BASE é…ç½®æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. é…ç½®åŠ è½½æµ‹è¯•</h2>
        <div id="config-test"></div>
    </div>

    <div class="test-section">
        <h2>2. URLè§„èŒƒåŒ–æµ‹è¯•</h2>
        <div id="url-test"></div>
    </div>

    <div class="test-section">
        <h2>3. å®é™…APIè°ƒç”¨æµ‹è¯•</h2>
        <div id="api-test"></div>
        <button onclick="testApiCall()">æµ‹è¯•APIè°ƒç”¨</button>
    </div>

    <script>
        // æ¨¡æ‹Ÿå°ç¨‹åºç¯å¢ƒçš„é…ç½®åŠ è½½
        function loadConfig() {
            try {
                // æ¨¡æ‹Ÿç¯å¢ƒæ£€æµ‹
                const ENV_CONFIG = {
                    development: {
                        BASE_URL: 'http://localhost:3000',
                        API_BASE: 'http://localhost:3000',
                        DEBUG: true
                    },
                    staging: {
                        BASE_URL: 'https://smart-cloths-attack.loca.lt',
                        API_BASE: 'https://smart-cloths-attack.loca.lt',
                        DEBUG: true
                    }
                };

                const CURRENT_ENV = 'development';
                const CURRENT_CONFIG = ENV_CONFIG[CURRENT_ENV];
                
                const CONFIG = {
                    API_BASE: CURRENT_CONFIG.API_BASE || CURRENT_CONFIG.BASE_URL,
                    BASE_URL: CURRENT_CONFIG.BASE_URL,
                    DEBUG: CURRENT_CONFIG.DEBUG,
                    ...CURRENT_CONFIG
                };

                return { CONFIG, CURRENT_CONFIG, CURRENT_ENV };
            } catch (error) {
                return { error: error.message };
            }
        }

        // URLè§„èŒƒåŒ–å‡½æ•°
        function normalizeUrl(u, CONFIG) {
            if (u && typeof u === 'object' && u.url) {
                u = u.url;
            }
            
            if (typeof u !== 'string') {
                return '';
            }

            if (u.startsWith('/')) {
                return `${CONFIG.API_BASE}${u}`;
            }
            
            return u;
        }

        // æµ‹è¯•é…ç½®åŠ è½½
        function testConfigLoading() {
            const result = loadConfig();
            const testDiv = document.getElementById('config-test');
            
            if (result.error) {
                testDiv.innerHTML = `
                    <div class="test-result test-fail">
                        <strong>âŒ é…ç½®åŠ è½½å¤±è´¥:</strong> ${result.error}
                    </div>
                `;
                return null;
            }

            const { CONFIG, CURRENT_CONFIG, CURRENT_ENV } = result;
            
            let html = `
                <div class="test-result test-pass">
                    <strong>âœ… é…ç½®åŠ è½½æˆåŠŸ</strong>
                </div>
                <pre>å½“å‰ç¯å¢ƒ: ${CURRENT_ENV}
CONFIG.API_BASE: ${CONFIG.API_BASE}
CONFIG.BASE_URL: ${CONFIG.BASE_URL}
CONFIG.DEBUG: ${CONFIG.DEBUG}</pre>
            `;

            if (!CONFIG.API_BASE) {
                html += `
                    <div class="test-result test-fail">
                        <strong>âŒ CONFIG.API_BASE æœªå®šä¹‰</strong>
                    </div>
                `;
            } else {
                html += `
                    <div class="test-result test-pass">
                        <strong>âœ… CONFIG.API_BASE å·²æ­£ç¡®è®¾ç½®</strong>
                    </div>
                `;
            }

            testDiv.innerHTML = html;
            return CONFIG;
        }

        // æµ‹è¯•URLè§„èŒƒåŒ–
        function testUrlNormalization(CONFIG) {
            if (!CONFIG) return;
            
            const testCases = [
                { input: '/api/upload', expected: `${CONFIG.API_BASE}/api/upload` },
                { input: { url: '/api/share' }, expected: `${CONFIG.API_BASE}/api/share` },
                { input: 'https://example.com/image.jpg', expected: 'https://example.com/image.jpg' },
                { input: '', expected: '' },
                { input: null, expected: '' },
                { input: undefined, expected: '' }
            ];

            let html = '';
            let allPassed = true;

            testCases.forEach((testCase, index) => {
                const result = normalizeUrl(testCase.input, CONFIG);
                const passed = result === testCase.expected;
                allPassed = allPassed && passed;

                html += `
                    <div class="test-result ${passed ? 'test-pass' : 'test-fail'}">
                        <strong>æµ‹è¯• ${index + 1}: ${passed ? 'âœ…' : 'âŒ'}</strong><br>
                        è¾“å…¥: <code>${JSON.stringify(testCase.input)}</code><br>
                        æœŸæœ›: <code>${testCase.expected}</code><br>
                        å®é™…: <code>${result}</code>
                    </div>
                `;
            });

            if (allPassed) {
                html = `<div class="test-result test-pass"><strong>âœ… æ‰€æœ‰URLè§„èŒƒåŒ–æµ‹è¯•é€šè¿‡</strong></div>` + html;
            } else {
                html = `<div class="test-result test-fail"><strong>âŒ éƒ¨åˆ†URLè§„èŒƒåŒ–æµ‹è¯•å¤±è´¥</strong></div>` + html;
            }

            document.getElementById('url-test').innerHTML = html;
        }

        // æµ‹è¯•APIè°ƒç”¨
        async function testApiCall() {
            const result = loadConfig();
            if (result.error) {
                document.getElementById('api-test').innerHTML = `
                    <div class="test-result test-fail">
                        <strong>âŒ æ— æ³•åŠ è½½é…ç½®è¿›è¡ŒAPIæµ‹è¯•</strong>
                    </div>
                `;
                return;
            }

            const { CONFIG } = result;
            const testDiv = document.getElementById('api-test');
            
            testDiv.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨æµ‹è¯•APIè¿æ¥...</div>';

            try {
                // æµ‹è¯•æœåŠ¡å™¨å¥åº·æ£€æŸ¥
                const healthUrl = `${CONFIG.API_BASE}/health`;
                console.log('æµ‹è¯•URL:', healthUrl);
                
                const response = await fetch(healthUrl);
                const data = await response.text();
                
                if (response.ok) {
                    testDiv.innerHTML = `
                        <div class="test-result test-pass">
                            <strong>âœ… APIè¿æ¥æµ‹è¯•æˆåŠŸ</strong><br>
                            URL: <code>${healthUrl}</code><br>
                            çŠ¶æ€: ${response.status}<br>
                            å“åº”: <pre>${data}</pre>
                        </div>
                    `;
                } else {
                    testDiv.innerHTML = `
                        <div class="test-result test-fail">
                            <strong>âŒ APIè¿æ¥æµ‹è¯•å¤±è´¥</strong><br>
                            URL: <code>${healthUrl}</code><br>
                            çŠ¶æ€: ${response.status}<br>
                            å“åº”: <pre>${data}</pre>
                        </div>
                    `;
                }
            } catch (error) {
                testDiv.innerHTML = `
                    <div class="test-result test-fail">
                        <strong>âŒ APIè¿æ¥æµ‹è¯•å‡ºé”™</strong><br>
                        é”™è¯¯: ${error.message}<br>
                        è¯·ç¡®ä¿æœåŠ¡å™¨æ­£åœ¨è¿è¡Œåœ¨ ${CONFIG.API_BASE}
                    </div>
                `;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è¿è¡Œæµ‹è¯•
        window.onload = function() {
            console.log('å¼€å§‹CONFIG.API_BASEé…ç½®æµ‹è¯•...');
            const CONFIG = testConfigLoading();
            testUrlNormalization(CONFIG);
        };
    </script>
</body>
</html>